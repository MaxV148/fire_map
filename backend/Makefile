.PHONY: help upgrade downgrade autogenerate history current init-db clean-db

# Makefile fÃ¼r Alembic Database Migrations

# Shell explizit auf bash setzen fÃ¼r source-Befehl
SHELL := /bin/bash

# Virtuelle Umgebung aktivieren
VENV = .venv/bin/activate

help: ## Zeigt diese Hilfe an
	@echo "VerfÃ¼gbare Alembic-Befehle:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

upgrade: ## FÃ¼hrt alle ausstehenden Migrationen aus (upgrade head)
	@echo "ğŸš€ FÃ¼hre Datenbank-Upgrade aus..."
	@source $(VENV) && alembic upgrade head
	@echo "âœ… Datenbank-Upgrade abgeschlossen!"

downgrade: ## FÃ¼hrt eine Migration zurÃ¼ck (downgrade -1)
	@echo "â¬‡ï¸  FÃ¼hre Datenbank-Downgrade aus..."
	@source $(VENV) && alembic downgrade -1
	@echo "âœ… Datenbank-Downgrade abgeschlossen!"

downgrade-base: ## FÃ¼hrt alle Migrationen zurÃ¼ck (downgrade base)
	@echo "âš ï¸  ACHTUNG: Alle Migrationen werden zurÃ¼ckgefÃ¼hrt!"
	@read -p "Sind Sie sicher? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	@source $(VENV) && alembic downgrade base
	@echo "âœ… Datenbank auf Basis zurÃ¼ckgesetzt!"

autogenerate: ## Erstellt eine neue Migration basierend auf ModellÃ¤nderungen
	@echo "ğŸ“ Erstelle neue Migration..."
	@read -p "Migration Name: " name; \
	source $(VENV) && alembic revision --autogenerate -m "$$name"
	@echo "âœ… Migration erstellt!"

revision: ## Erstellt eine leere Migration-Datei
	@echo "ğŸ“ Erstelle leere Migration..."
	@read -p "Migration Name: " name; \
	source $(VENV) && alembic revision -m "$$name"
	@echo "âœ… Leere Migration erstellt!"

history: ## Zeigt die Migration-Historie an
	@echo "ğŸ“š Migration-Historie:"
	@source $(VENV) && alembic history --verbose

current: ## Zeigt die aktuelle Migration-Version an
	@echo "ğŸ“ Aktuelle Migration-Version:"
	@source $(VENV) && alembic current --verbose

stamp: ## Markiert die Datenbank mit einer bestimmten Migration-Version (ohne AusfÃ¼hrung)
	@echo "ğŸ·ï¸  Datenbank-Version markieren..."
	@read -p "Migration-Version (head fÃ¼r neueste): " version; \
	source $(VENV) && alembic stamp "$$version"
	@echo "âœ… Datenbank-Version markiert!"

check: ## ÃœberprÃ¼ft, ob Migrationen ausstehen
	@echo "ğŸ” ÃœberprÃ¼fe ausstehende Migrationen..."
	@source $(VENV) && alembic current
	@echo "ğŸ“‹ VerfÃ¼gbare Migrationen:"
	@source $(VENV) && alembic heads

init-db: ## Initialisiert die Datenbank (upgrade head)
	@echo "ğŸ—ï¸  Initialisiere Datenbank..."
	@source $(VENV) && alembic upgrade head
	@echo "âœ… Datenbank initialisiert!"

# Entwickler-Befehle
dev-reset: ## Setzt die Entwicklungsdatenbank komplett zurÃ¼ck (VORSICHT!)
	@echo "âš ï¸  WARNUNG: Dies lÃ¶scht alle Daten in der Entwicklungsdatenbank!"
	@read -p "Sind Sie ABSOLUT sicher? Geben Sie 'RESET' ein: " confirm && [ "$$confirm" = "RESET" ] || exit 1
	@source $(VENV) && alembic downgrade base
	@source $(VENV) && alembic upgrade head
	@echo "âœ… Entwicklungsdatenbank zurÃ¼ckgesetzt!"

show-sql: ## Zeigt SQL fÃ¼r Upgrade ohne AusfÃ¼hrung (dry-run)
	@echo "ğŸ“„ SQL fÃ¼r Upgrade (ohne AusfÃ¼hrung):"
	@source $(VENV) && alembic upgrade head --sql

show-downgrade-sql: ## Zeigt SQL fÃ¼r Downgrade ohne AusfÃ¼hrung (dry-run)
	@echo "ğŸ“„ SQL fÃ¼r Downgrade (ohne AusfÃ¼hrung):"
	@source $(VENV) && alembic downgrade -1 --sql 